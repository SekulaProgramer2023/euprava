<nav class="navbar">
  <div class="navbar-left">
    <img src="https://www.scns.rs/wp-content/uploads/2024/03/SC-Novi-Sad-logo-horizontalni.png" alt="Logo" class="logo">
    <a [routerLink]="['/menza/home']" class="nav-link" id="dom">Stranica Menza</a>
    <a [routerLink]="['/domovi/dogadjaj']" class="nav-link" id="dogadjaji">Dogaƒëaji</a>
  </div>

  <div class="navbar-center">
    <span class="navbar-title">Studentski domovi</span>
  </div>

  <div class="navbar-right">
    <div class="profile-container" (click)="toggleDropdown()">
      <img src="https://static.vecteezy.com/system/resources/previews/005/544/718/non_2x/profile-icon-design-free-vector.jpg" alt="Profil" class="profile-pic">
      
      <!-- Dropdown meni -->
      <div class="dropdown-menu" *ngIf="dropdownOpen">
        <button (click)="goToProfile($event)">Profile</button>
        <button (click)="goToNotifications($event)">Notifications</button>
        <button (click)="logout($event)">Logout</button>
      </div>
    </div>
  </div>
</nav>


<div class="home-container">
  <h1>Raspolo≈æivost soba</h1>

  <div class="cards-container">
  <div *ngFor="let soba of sobe" class="soba-card" [ngClass]="soba.IsFree ? 'slobodna' : 'zauzeta'">
  <h3>Soba {{ soba.roomNumber }}</h3>
  <p>Status: {{ soba.IsFree ? 'Slobodna' : 'Zauzeta' }}</p>
  <p>Kapacitet: {{ soba.capacity }}</p>
  <p>
  Proseƒçna ocena: 
  <span *ngIf="averageRatingMap[soba.id] !== null">
    {{ averageRatingMap[soba.id] | number:'1.1-2' }} ‚≠ê
  </span>
  <span *ngIf="averageRatingMap[soba.id] === null">
    Nema ocena
  </span>
</p>

<!-- Dugme za otvaranje modal-a sa review-ima (uvek vidljivo) -->
<button class="show-reviews-btn" (click)="openReviewsModal(soba.id)">
  Prika≈æi review-e
</button>

<!-- Modal -->
<div style=" background-color: #64b5f6;" class="modal-backdrop" *ngIf="showReviewsModal">
  <div style="color: black; height: auto;" class="modal">
    <h2>Review-i za sobu</h2>

    <div *ngFor="let r of reviewsForSoba; let i = index" class="review-item">
  <p><strong>Korisnik:</strong> {{ userMap[r.user_id]?.name }} {{ userMap[r.user_id]?.surname }}</p>
  <p><strong>Ocena:</strong> {{ r.rating }} ‚≠ê</p>
  <p><strong>Komentar:</strong> {{ r.comment || 'Nema komentara' }}</p>
  <hr>
</div>


    <ng-template #noReviews>
      <p>Nema review-a za ovu sobu.</p>
    </ng-template>

    <button (click)="closeReviewsModal()">Zatvori</button>
    <!-- Dugme za dodavanje recenzije (samo za useljene studente) -->
@if (role === 'User' && isUserInSelectedRoom()) {
  <div style="margin-top: 15px;">
    <button class="add-review-btn" 
            (click)="openAddReviewModal()" 
            [disabled]="hasUserReviewed()">
      Dodaj recenziju
    </button>
  </div>
}
@if (hasUserReviewed()) {
  <p style="color: gray; font-size: 0.9em; margin-top: 5px;">
    Veƒá ste ostavili recenziju za ovu sobu 
  </p>
}
  </div>
</div>

   <!-- Ako je role User i ovo je njegova soba -->
    <button 
      *ngIf="role === 'User' && soba.users.includes(userId)" 
      class="kvar-btn"
      (click)="openKvarModal(soba.id)">
      Prijavi kvar
    </button>

  <!-- Prikaz studenata ako je admin -->
<div *ngIf="role === 'Admin' && soba.users.length > 0" class="students-container">
  <p style="text-align: center;">Studenti u sobi:</p>
  <div class="students-tags">
    <span *ngFor="let userId of soba.users" class="student-tag">
      üë§ {{ userMap[userId]?.name }} {{ userMap[userId]?.surname }}
    </span>
  </div>
</div>

<!-- Prikaz kvarova samo za admina -->
<div *ngIf="role === 'Admin' && (kvarMap[soba.id]?.length ?? 0) > 0" class="kvar-container">
  <p>Kvarovi u sobi</p>
  <ul>
    <li *ngFor="let kvar of kvarMap[soba.id]; let i = index">
  <span class="kvar-link" (click)="openKvarDetailModal(kvar)">
    üõ†Ô∏è Kvar {{ i + 1 }}
  </span>
</li>

  </ul>
</div>

<!-- Modal za detalje kvara -->
<div class="modal-backdrop" *ngIf="showKvarDetailModal">
  <div style="color: black" class="modal">
    <h2>Detalji kvara</h2>

    <!-- Provera da selectedKvar postoji -->
    <div *ngIf="selectedKvar">
      <p><strong>Kvar ID:</strong> {{ selectedKvar.id }}</p>
      <p><strong>Opis:</strong> {{ selectedKvar.description }}</p>
      <p><strong>Status:</strong> {{ selectedKvar.status ? 'Re≈°en ‚úÖ' : 'Nere≈°en ‚ùå' }}</p>
    </div>

    <div class="modal-actions" style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
      <button 
        *ngIf="selectedKvar && !selectedKvar.status" 
        (click)="resolveSelectedKvar()">
        Oznaƒçi kao re≈°en
      </button>
      <button (click)="closeKvarDetailModal()">Zatvori</button>
    </div>
  </div>
</div>





  <!-- Dugme samo ako je role == user -->
  <button class="useliSe" 
      *ngIf="role === 'User'" 
      [disabled]="!soba.IsFree"
      (click)="useliStudenta(soba.id)">
    Useli se
  </button>
</div>


</div>


<!-- Modal za gre≈°ke -->
<div class="modal-backdrop" *ngIf="showErrorModal">
  <div class="modal">
    <h2>Gre≈°ka</h2>
    <p>{{ errorMessage }}</p>
    <button (click)="closeErrorModal()">OK</button>
  </div>
</div>


<!-- Modal za prijavu kvara -->
<div class="modal-backdrop" *ngIf="showKvarModal">
  <div class="modal">
    <h2>Prijavi kvar</h2>
    <textarea [(ngModel)]="kvarDescription" placeholder="Unesi opis kvara..." rows="15" style="width:100%;"></textarea>
    <div class="modal-actions" style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
      <button (click)="submitKvar()">Po≈°alji</button>
      <button (click)="closeKvarModal()">Otka≈æi</button>
    </div>
  </div>
</div>

<!-- Modal za dodavanje recenzije -->
<div class="modal-backdrop" *ngIf="showAddReviewModal">
  <div class="modal">
    <h2>Dodaj recenziju</h2>
    
    <label>Ocena (1-5):</label>
    <input type="number" [(ngModel)]="newReview2.rating1" min="1" max="5" style="width: 100%;" />

    <label>Komentar:</label>
    <textarea [(ngModel)]="newReview2.comment" rows="4" style="width: 100%;"></textarea>

    <div class="modal-actions" style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
      <button (click)="submitReview()">Po≈°alji</button>
      <button (click)="closeAddReviewModal()">Otka≈æi</button>
    </div>
  </div>
</div>